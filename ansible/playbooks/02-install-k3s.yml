# =============================================================================
# Playbook: K3s HA-Cluster Installation
# =============================================================================
# Installiert K3s im HA-Modus mit embedded etcd auf 3 Server-Nodes.
#
# Voraussetzungen:
#   - SSH-Keys müssen bereits verteilt sein (01-setup-ssh-keys.yml)
#   - secrets.yml muss erstellt sein mit vault_k3s_token
#
# Ausführung:
#   ansible-playbook playbooks/02-install-k3s.yml
#
# Mit Vault:
#   ansible-playbook playbooks/02-install-k3s.yml --ask-vault-pass
# =============================================================================

---
- name: K3s Cluster vorbereiten
  hosts: k3s_cluster
  become: true
  vars_files:
    - ../inventory/dev/group_vars/secrets.yml
  
  tasks:
    - name: System-Pakete aktualisieren
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Notwendige Pakete installieren
      ansible.builtin.apt:
        name:
          - curl
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    - name: Swap deaktivieren (für Kubernetes)
      ansible.builtin.command: swapoff -a
      changed_when: false

    - name: Swap dauerhaft deaktivieren
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '.*swap.*'
        state: absent

# =============================================================================
# K3s auf erstem Server installieren (Cluster initialisieren)
# =============================================================================

- name: K3s Initial Server installieren
  hosts: k3s_initial_server
  become: true
  vars_files:
    - ../inventory/dev/group_vars/secrets.yml
  
  tasks:
    - name: Prüfen ob K3s bereits installiert ist
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: K3s Konfigurationsverzeichnis erstellen
      ansible.builtin.file:
        path: /etc/rancher/k3s
        state: directory
        mode: '0755'

    - name: K3s Config-Datei erstellen
      ansible.builtin.template:
        src: ../templates/k3s-config.yaml.j2
        dest: /etc/rancher/k3s/config.yaml
        mode: '0644'

    - name: K3s auf Initial Server installieren
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | \
        INSTALL_K3S_CHANNEL={{ k3s_channel }} \
        K3S_TOKEN={{ vault_k3s_token }} \
        sh -s - server \
        --cluster-init
      args:
        creates: /usr/local/bin/k3s
      environment:
        INSTALL_K3S_SKIP_START: "false"

    - name: Warten bis K3s API erreichbar ist
      ansible.builtin.wait_for:
        port: 6443
        host: "{{ ansible_host }}"
        delay: 10
        timeout: 300

    - name: Warten bis Node Ready ist
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl get node {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      changed_when: false

    - name: Node-Token für weitere Server holen
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_node_token

    - name: Node-Token als Fakt setzen
      ansible.builtin.set_fact:
        k3s_cluster_token: "{{ k3s_node_token.content | b64decode | trim }}"
      delegate_to: localhost
      delegate_facts: true

# =============================================================================
# K3s auf weiteren Servern installieren (Cluster beitreten)
# =============================================================================

- name: K3s Additional Servers installieren
  hosts: k3s_additional_servers
  become: true
  serial: 1  # Einen Server nach dem anderen
  vars_files:
    - ../inventory/dev/group_vars/secrets.yml
  
  tasks:
    - name: Prüfen ob K3s bereits installiert ist
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: K3s Konfigurationsverzeichnis erstellen
      ansible.builtin.file:
        path: /etc/rancher/k3s
        state: directory
        mode: '0755'

    - name: K3s Config-Datei erstellen
      ansible.builtin.template:
        src: ../templates/k3s-config.yaml.j2
        dest: /etc/rancher/k3s/config.yaml
        mode: '0644'

    - name: K3s auf Additional Server installieren
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | \
        INSTALL_K3S_CHANNEL={{ k3s_channel }} \
        K3S_TOKEN={{ vault_k3s_token }} \
        sh -s - server \
        --server {{ k3s_server_url }}
      args:
        creates: /usr/local/bin/k3s
      environment:
        INSTALL_K3S_SKIP_START: "false"

    - name: Warten bis K3s API erreichbar ist
      ansible.builtin.wait_for:
        port: 6443
        host: "{{ ansible_host }}"
        delay: 10
        timeout: 300

    - name: Warten bis Node Ready ist
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl get node {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      changed_when: false

# =============================================================================
# Cluster-Status prüfen und kubeconfig holen
# =============================================================================

- name: Cluster finalisieren
  hosts: k3s_initial_server
  become: true
  
  tasks:
    - name: Cluster-Status prüfen
      ansible.builtin.shell: /usr/local/bin/k3s kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false

    - name: Cluster-Nodes anzeigen
      ansible.builtin.debug:
        msg: "{{ cluster_nodes.stdout_lines }}"

    - name: etcd-Status prüfen
      ansible.builtin.shell: /usr/local/bin/k3s etcd-snapshot list 2>/dev/null || echo "etcd OK"
      register: etcd_status
      changed_when: false
      failed_when: false

    - name: kubeconfig Datei lesen
      ansible.builtin.slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_content

    - name: kubeconfig lokal speichern
      ansible.builtin.copy:
        content: "{{ kubeconfig_content.content | b64decode | replace('127.0.0.1', ansible_host) }}"
        dest: "{{ playbook_dir }}/../../kubeconfig-dev.yaml"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Hinweis zur kubeconfig
      ansible.builtin.debug:
        msg: |
          ============================================================
          K3s Cluster erfolgreich installiert!
          
          kubeconfig wurde gespeichert unter:
            {{ playbook_dir }}/../../kubeconfig-dev.yaml
          
          Verwendung:
            export KUBECONFIG={{ playbook_dir }}/../../kubeconfig-dev.yaml
            kubectl get nodes
          
          Oder kopieren nach ~/.kube/config
          ============================================================
